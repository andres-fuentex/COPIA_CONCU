<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bogot√° Visible - Gemelo Digital</title>
    
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <style>
        body, html { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Helvetica', sans-serif; background-color: #000; }
        #cesiumContainer { width: 100%; height: 100%; }
        
        /* Panel Flotante */
        #uiPanel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(20, 20, 20, 0.9);
            color: #eee;
            padding: 20px;
            border-radius: 12px;
            border-left: 6px solid #27AE60;
            z-index: 999;
            width: 260px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }
        h2 { margin: 0 0 15px 0; font-size: 18px; color: #fff; }
        p { margin: 8px 0; font-size: 14px; color: #ccc; }
        .dato { font-weight: bold; color: #F1C40F; font-size: 15px; } 
        .footer { margin-top: 15px; border-top: 1px solid #444; padding-top: 10px; font-size: 11px; color: #888; }
    </style>
</head>
<body>

    <div id="cesiumContainer"></div>

    <div id="uiPanel">
        <h2 id="titulo">üìç Cargando datos...</h2>
        <p>Radio: <span id="lblRadio" class="dato">--</span> m</p>
        <p>Lat: <span id="lblLat" class="dato">--</span></p>
        <p>Lon: <span id="lblLon" class="dato">--</span></p>
        <div class="footer">Gemelo Digital 2025 ‚Ä¢ Cesium Ion</div>
    </div>

    <script>
        // ==========================================
        // üîë TOKEN CONFIGURADO (Ya inclu√≠ el tuyo aqu√≠)
        // ==========================================
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3NmY0NDc1NS0wNTI1LTQ5MzktODU4Yi04MzEyZDBhNGQ1OGMiLCJpZCI6MzY3NDIwLCJpYXQiOjE3NjUxMjUyNzJ9.rNorYTcXLUMNiocHyuT9VPqrMUdC6yHvbKq8kW-PVds'; 
        // ==========================================

        // 1. CAPTURAR DATOS URL
        const params = new URLSearchParams(window.location.search);
        const lat = parseFloat(params.get('lat')) || 4.5981;
        const lon = parseFloat(params.get('lon')) || -74.0760;
        const radio = parseFloat(params.get('radio')) || 500;
        const localidad = params.get('loc') || "Bogot√° D.C.";

        // Actualizar UI
        document.getElementById('titulo').innerText = `üìç ${localidad}`;
        document.getElementById('lblRadio').innerText = radio;
        document.getElementById('lblLat').innerText = lat.toFixed(4);
        document.getElementById('lblLon').innerText = lon.toFixed(4);

        async function iniciarCesium() {
            try {
                // 2. INICIAR VISOR (Sintaxis Actualizada 2025)
                const viewer = new Cesium.Viewer('cesiumContainer', {
                    terrain: Cesium.Terrain.fromWorldTerrain(), // NUEVA SINTAXIS PARA TERRENO
                    animation: false,
                    timeline: false,
                    baseLayerPicker: true, 
                    fullscreenButton: false,
                    homeButton: false,
                    infoBox: false,
                    selectionIndicator: false,
                    sceneModePicker: false,
                    navigationHelpButton: false,
                    geocoder: false,
                    creditContainer: document.createElement("div")
                });

                // 3. AGREGAR EDIFICIOS 3D (CORRECCI√ìN CR√çTICA: USAMOS ASYNC)
                try {
                    const edificios = await Cesium.createOsmBuildingsAsync();
                    viewer.scene.primitives.add(edificios);
                } catch (e) {
                    console.log("Advertencia: No se pudieron cargar los edificios 3D", e);
                }

                // 4. DIBUJAR RADIO (C√çRCULO AMARILLO)
                viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(lon, lat),
                    ellipse: {
                        semiMinorAxis: radio,
                        semiMajorAxis: radio,
                        material: Cesium.Color.YELLOW.withAlpha(0.3),
                        outline: true,
                        outlineColor: Cesium.Color.YELLOW,
                        outlineWidth: 3,
                        height: 0 // Evita conflictos con el terreno
                    }
                });

                // 5. DIBUJAR PUNTO CENTRAL
                viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(lon, lat),
                    point: { pixelSize: 10, color: Cesium.Color.RED, outlineColor: Cesium.Color.WHITE, outlineWidth: 2, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND }
                });

                // 6. VUELO DE C√ÅMARA
                const altura = radio * 3.5;
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(lon, lat - 0.005, altura),
                    orientation: {
                        heading: Cesium.Math.toRadians(0.0),
                        pitch: Cesium.Math.toRadians(-45.0),
                        roll: 0.0
                    },
                    duration: 3
                });

                console.log("‚úÖ Cesium Ion conectado correctamente (Modo Async).");

            } catch (error) {
                console.error("‚ùå Error iniciando Cesium:", error);
                alert("Error t√©cnico: " + error.message);
            }
        }

        // Ejecutar la funci√≥n
        iniciarCesium();
    </script>
</body>
</html>