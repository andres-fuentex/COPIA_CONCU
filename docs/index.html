<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bogot√° Visible - Gemelo Digital</title>
    
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <style>
        body, html { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Helvetica', sans-serif; background-color: #000; }
        #cesiumContainer { width: 100%; height: 100%; }
        
        #uiPanel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(20, 10, 30, 0.95);
            color: #eee;
            padding: 20px;
            border-radius: 12px;
            border-left: 6px solid #FF69B4;
            z-index: 999;
            width: 260px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }
        h2 { margin: 0 0 15px 0; font-size: 18px; color: #fff; }
        p { margin: 8px 0; font-size: 14px; color: #ccc; }
        .dato { font-weight: bold; color: #FF69B4; font-size: 15px; } 
        .footer { margin-top: 15px; border-top: 1px solid #444; padding-top: 10px; font-size: 11px; color: #888; }
    </style>
</head>
<body>

    <div id="cesiumContainer"></div>

    <div id="uiPanel">
        <h2 id="titulo">üìç Cargando datos...</h2>
        <p>Radio: <span id="lblRadio" class="dato">--</span> m</p>
        <p>Lat: <span id="lblLat" class="dato">--</span></p>
        <p>Lon: <span id="lblLon" class="dato">--</span></p>
        <div class="footer">Gemelo Digital 2025 ‚Ä¢ Cesium Ion</div>
    </div>

    <script>
        // üîë TOKEN CONFIGURADO
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3NmY0NDc1NS0wNTI1LTQ5MzktODU4Yi04MzEyZDBhNGQ1OGMiLCJpZCI6MzY3NDIwLCJpYXQiOjE3NjUxMjUyNzJ9.rNorYTcXLUMNiocHyuT9VPqrMUdC6yHvbKq8kW-PVds'; 

        const params = new URLSearchParams(window.location.search);
        const lat = parseFloat(params.get('lat')) || 4.5981;
        const lon = parseFloat(params.get('lon')) || -74.0760;
        const radio = parseFloat(params.get('radio')) || 500;
        const localidad = params.get('loc') || "Bogot√° D.C.";

        document.getElementById('titulo').innerText = `üìç ${localidad}`;
        document.getElementById('lblRadio').innerText = radio;
        document.getElementById('lblLat').innerText = lat.toFixed(4);
        document.getElementById('lblLon').innerText = lon.toFixed(4);

        async function iniciarCesium() {
            try {
                const viewer = new Cesium.Viewer('cesiumContainer', {
                    terrain: Cesium.Terrain.fromWorldTerrain(), 
                    animation: false,
                    timeline: false,
                    baseLayerPicker: true, 
                    fullscreenButton: false,
                    homeButton: false,
                    infoBox: true,
                    selectionIndicator: true,
                    sceneModePicker: false,
                    navigationHelpButton: false,
                    geocoder: false,
                    creditContainer: document.createElement("div")
                });

                // Definimos el centro geogr√°fico para hacer c√°lculos matem√°ticos
                const centroUsuario = Cesium.Cartesian3.fromDegrees(lon, lat);

                // ============================================================
                // CAPA 1: TRANSPORTE (Con Filtro Inteligente)
                // ============================================================
                try {
                    const urlTransporte = 'https://raw.githubusercontent.com/andres-fuentex/CONCURSO/main/DATOS_LIMPIOS/dim_transporte.geojson';
                    
                    const transporteDS = await Cesium.GeoJsonDataSource.load(urlTransporte, {
                        stroke: Cesium.Color.RED,
                        fill: Cesium.Color.RED,
                        markerSymbol: 'bus'
                    });

                    const entities = transporteDS.entities.values;
                    
                    // --- ALGORITMO DE FILTRADO ---
                    for (let i = 0; i < entities.length; i++) {
                        const entity = entities[i];
                        
                        // 1. Obtener posici√≥n exacta de la estaci√≥n
                        const posicionEstacion = entity.position.getValue(Cesium.JulianDate.now());
                        
                        // 2. Calcular distancia matem√°tica (Euclidiana 3D) al centro del usuario
                        const distancia = Cesium.Cartesian3.distance(centroUsuario, posicionEstacion);

                        // 3. L√≥gica de Negocio: ¬øEst√° dentro del radio?
                        if (distancia <= radio) {
                            // SI EST√Å DENTRO: Lo dejamos visible y lo ponemos bonito
                            entity.point = new Cesium.PointGraphics({
                                color: Cesium.Color.RED,
                                pixelSize: 10,
                                outlineColor: Cesium.Color.WHITE,
                                outlineWidth: 2,
                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                                disableDepthTestDistance: Number.POSITIVE_INFINITY
                            });
                            entity.billboard = undefined; // Quitamos el pin gen√©rico
                        } else {
                            // NO EST√Å DENTRO: Lo desaparecemos
                            entity.show = false;
                        }
                    }

                    viewer.dataSources.add(transporteDS);
                    console.log("üöå Filtro aplicado: Solo estaciones en el radio visible.");

                } catch (e) {
                    console.error("No se pudo cargar transporte:", e);
                }

                // ============================================================
                // RADIO VISUAL (ROSA)
                // ============================================================
                viewer.entities.add({
                    position: centroUsuario,
                    ellipse: {
                        semiMinorAxis: radio,
                        semiMajorAxis: radio,
                        material: Cesium.Color.HOTPINK.withAlpha(0.2),
                        outline: true,
                        outlineColor: Cesium.Color.DEEPPINK,
                        outlineWidth: 2
                    }
                });

                // Punto Central
                viewer.entities.add({
                    position: centroUsuario,
                    point: { 
                        pixelSize: 12, 
                        color: Cesium.Color.WHITE, 
                        outlineColor: Cesium.Color.HOTPINK, 
                        outlineWidth: 3, 
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND 
                    }
                });

                // ============================================================
                // C√ÅMARA
                // ============================================================
                const altura = radio * 3.5; 
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(lon, lat - 0.004, altura),
                    orientation: {
                        heading: Cesium.Math.toRadians(0.0),
                        pitch: Cesium.Math.toRadians(-35.0),
                        roll: 0.0
                    },
                    duration: 3.5
                });

                console.log("‚úÖ Gemelo Digital: Transporte Filtrado");

            } catch (error) {
                alert("Error: " + error.message);
            }
        }

        iniciarCesium();
    </script>
</body>
</html>